<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qulacsvis.visualization.text &mdash; qulacsvis 0.7.3 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            qulacsvis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../options.html">How to use options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">qulacsvis</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">qulacsvis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">qulacsvis.visualization.text</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qulacsvis.visualization.text</h1><div class="highlight"><pre>
<span></span><span class="c1"># mypy: ignore-errors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dataclasses</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qulacs</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">QuantumGateBase</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">qulacsvis.models.circuit</span><span class="w"> </span><span class="kn">import</span> <span class="n">ControlQubitInfo</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">qulacsvis.utils.gate</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_text_style</span>


<div class="viewcode-block" id="DotStyle"><a class="viewcode-back" href="../../../qulacsvis.visualization.text.html#qulacsvis.visualization.text.DotStyle">[docs]</a><span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DotStyle</span><span class="p">:</span>
    <span class="n">ctrl</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ctrlo</span><span class="p">:</span> <span class="nb">str</span></div>


<span class="n">CON_DOT_STYLE</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DotStyle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="n">DotStyle</span><span class="p">(</span><span class="n">ctrl</span><span class="o">=</span><span class="s2">&quot;●&quot;</span><span class="p">,</span> <span class="n">ctrlo</span><span class="o">=</span><span class="s2">&quot;○&quot;</span><span class="p">),</span>
    <span class="s2">&quot;small&quot;</span><span class="p">:</span> <span class="n">DotStyle</span><span class="p">(</span><span class="n">ctrl</span><span class="o">=</span><span class="s2">&quot;･&quot;</span><span class="p">,</span> <span class="n">ctrlo</span><span class="o">=</span><span class="s2">&quot;⚬&quot;</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_con_dot</span><span class="p">(</span><span class="n">dot</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DotStyle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set a character to mean control qubit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dot: str</span>
<span class="sd">        dot style &quot;large&quot; or &quot;small&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        dot character</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dot</span> <span class="ow">in</span> <span class="n">CON_DOT_STYLE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CON_DOT_STYLE</span><span class="p">[</span><span class="n">dot</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CON_DOT_STYLE</span><span class="p">[</span><span class="s2">&quot;large&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_Gate_AA_Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;qulacsの量子ゲート(QuantumGateBase)を描画するためのクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># このgate_stringにゲートの上の部分から文字列を作成して追加していきゲートの形を作成</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 制御qubitの記号</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span> <span class="o">=</span> <span class="n">_set_con_dot</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">:</span> <span class="n">QuantumGateBase</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;引数のゲートを文字列表示で返してくれる関数</span>
<span class="sd">        Argeuments:</span>
<span class="sd">            gate:    Qulacsのゲート(QuantumGateBase)</span>
<span class="sd">            index:   circuitに追加された順番を示す値, 1000以上の場合は表示が崩れる</span>
<span class="sd">            verbose: Trueだと詳細出力, 表示されるゲートにcircuitで追加された順番(引数のindex)を表示</span>
<span class="sd">        Return:</span>
<span class="sd">            gate_string: 1次元のリスト(リストのリスト)</span>
<span class="sd">                         1次元目が行の指定, 2次元目が文字の指定</span>

<span class="sd">        ゲートの表示法とパーツの説明(CNOTを例に)</span>
<span class="sd">        ・大きさは縦8×横7</span>
<span class="sd">          0123456       パーツ名                 説明</span>
<span class="sd">        0            &lt;= control_q_head       : 制御qubitのときの空白文字</span>
<span class="sd">        1            &lt;= control_q_name       : 上に同じ</span>
<span class="sd">        2 ---･---    &lt;= control(_o)_q_body   : このqubitが制御qubitであることを示す&quot;･,⚬&quot;</span>
<span class="sd">        3    |       &lt;= vertical_wire        : 制御qubitと接続する縦向きのワイヤー</span>
<span class="sd">        4   _|_      &lt;= gate_head            : ゲートの天井</span>
<span class="sd">        5  |CX |     &lt;= gate_name            : どのゲートかを表示するゲートの名前と左右の壁</span>
<span class="sd">        6 -|   |-    &lt;= gate_body_with_wire  : ゲートの左右の壁, ワイヤーのないものはgate_body</span>
<span class="sd">        7  |___|     &lt;= gate_botom           : ゲートの下底</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ゲートの文字列表現を初期化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># verboseに応じて回路への追加番号を表示させるかさせないか文字列を作成</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>

        <span class="c1"># 実際にゲートが適用されるターゲットqubitのリストと, コントロール用の制御qubitのリストを取得</span>
        <span class="n">t_list</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">get_target_index_list</span><span class="p">()</span>
        <span class="n">c_list</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">get_control_index_list</span><span class="p">()</span>
        <span class="n">cv_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ControlQubitInfo</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">control_value</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">control_value</span> <span class="ow">in</span> <span class="n">gate</span><span class="o">.</span><span class="n">get_control_index_value_list</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="c1"># ゲート作成時の引数の順番や, add_control_qubitメソッドなどで</span>
        <span class="c1"># 制御qubitを追加したときなどでリストが昇順になっていないことがあるのでソートしておく</span>
        <span class="n">t_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">c_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">cv_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># 制御qubitが実ゲート(ターゲットqubitにかかるゲート)より上に存在するかチェック</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">c_list</span><span class="p">):</span>
            <span class="c1"># 制御qubitが実ゲートより上に存在した</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># ターゲットqubitにかかるゲートより上側に存在する制御qubitの部分の文字列表現を作成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_upper_control_part</span><span class="p">(</span><span class="n">t_list</span><span class="p">,</span> <span class="n">cv_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 制御qubitが実ゲートより上に存在しない</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># ターゲットqubitにかかる部分のゲートの文字列表現を作成</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_target_part</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">t_list</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>

        <span class="c1"># 制御qubitが実ゲートの間に存在するときの制御qubitを描画</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_inner_control_part</span><span class="p">(</span><span class="n">t_list</span><span class="p">,</span> <span class="n">cv_list</span><span class="p">)</span>

        <span class="c1"># 制御qubitが実ゲート(ターゲットqubitにかかるゲート)より下に存在するかチェック</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">c_list</span><span class="p">):</span>
            <span class="c1"># ターゲットqubitにかかるゲートより上側に存在する制御qubitの部分の文字列表現を作成</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gen_lower_control_part</span><span class="p">(</span><span class="n">t_list</span><span class="p">,</span> <span class="n">cv_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_upper_control_part</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cv_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ControlQubitInfo</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ターゲットqubitにかかるゲートより上側に存在する制御qubitを描くメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 以下制御qubit用のパーツ作り</span>
        <span class="c1"># 制御qubit用の部分の形(空)</span>
        <span class="n">control_q_head</span> <span class="o">=</span> <span class="s2">&quot;       &quot;</span>
        <span class="c1"># 制御qubit用の部分の形(空)</span>
        <span class="n">control_q_name</span> <span class="o">=</span> <span class="s2">&quot;       &quot;</span>
        <span class="c1"># 制御qubit用の部分の接続の部分の形</span>
        <span class="n">control_q_body</span> <span class="o">=</span> <span class="s2">&quot;   </span><span class="si">{}</span><span class="s2">   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrl</span><span class="p">)</span>
        <span class="n">control_o_q_body</span> <span class="o">=</span> <span class="s2">&quot;   </span><span class="si">{}</span><span class="s2">   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrlo</span><span class="p">)</span>
        <span class="c1"># 制御信号用のワイヤーの形</span>
        <span class="n">vertical_wire</span> <span class="o">=</span> <span class="s2">&quot;   |   &quot;</span>

        <span class="c1"># ターゲットqubitにかかるゲートよりも上側に存在している制御qubitのリスト</span>
        <span class="n">upper_c_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ControlQubitInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cv_list</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 制御qubitの回路図を構成していく</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_q_head</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_q_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upper_c_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">control_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_o_q_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control_q_body</span><span class="p">)</span>
        <span class="c1"># 制御qubitと実ゲートのqubitでもっとも離れているqubit(実ゲートのqubitは一番上のqubit)を選び</span>
        <span class="c1"># 距離を計算. このqubitから下へと縦のワイヤーを引く</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">upper_c_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertical_wire</span><span class="p">)</span>

        <span class="c1"># 制御信号をどのワイヤーからとっているか表す&quot;･&quot;を描き込む</span>
        <span class="c1"># 最初の制御qubitは描き込み済みなので２つ目以降の制御qubitから</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">upper_c_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="c1"># 制御qubitと実ゲートのかかるqubitで最も近いものとがいくつ離れているか計算</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span>
            <span class="c1"># 仕様に合わせて位置を調整</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="c1"># 配列に&quot;･&quot;を描き込み(上書き)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">control_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="o">-</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_o_q_body</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="o">-</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_q_body</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_target_part</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">:</span> <span class="n">QuantumGateBase</span><span class="p">,</span> <span class="n">t_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">upper</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ターゲットqubitにかかる部分のゲートの文字列表現を描くメソッド&quot;&quot;&quot;</span>
        <span class="c1"># ターゲットqubitにかかる部分のゲートの大きさを取得</span>
        <span class="c1"># ゲートのかかるqubit同士が離れている場合はその間のqubitも使用すると考えて回路図を描くので,</span>
        <span class="c1"># 正確にはゲートのかかるqubitのうち一番上のqubitから一番下のqubitまでの大きさ</span>
        <span class="n">gate_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># ゲートの上部分の形</span>
        <span class="c1"># もしコントロールqubitが実ゲートよりも上にあるとき, つまり上から制御用のワイヤーが入るとき</span>
        <span class="c1"># ゲートの上の形は制御の線を接続した形になる</span>
        <span class="k">if</span> <span class="n">upper</span><span class="p">:</span>
            <span class="n">gate_head</span> <span class="o">=</span> <span class="s2">&quot;  _|_  &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gate_head</span> <span class="o">=</span> <span class="s2">&quot;  ___  &quot;</span>
        <span class="c1"># ゲートの名前が表示される部分の形</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># ゲートの横幅を３文字分でゲート名を作成</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="s2">&quot; |</span><span class="si">{}</span><span class="s2">| &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_text_style</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># もし新たに追加されたゲートなどで見つからなかったときは&quot;UnDeFined&quot;</span>
            <span class="n">gate_name</span> <span class="o">=</span> <span class="s2">&quot; |UDF| &quot;</span>
        <span class="c1"># ワイヤー付き, またはついていない部分のゲートの形</span>
        <span class="c1"># パラメータ付き回路やDenseMatrixの場合はこの部分にパラメータを入れて表示させたい</span>
        <span class="n">gate_body_with_wire</span> <span class="o">=</span> <span class="s2">&quot;-|   |-&quot;</span>
        <span class="n">gate_body</span> <span class="o">=</span> <span class="s2">&quot; |   | &quot;</span>
        <span class="c1"># ゲートの下部分の形</span>
        <span class="n">gate_bottom</span> <span class="o">=</span> <span class="s2">&quot; |___| &quot;</span>

        <span class="c1"># 作成を始める</span>
        <span class="k">if</span> <span class="n">gate_name</span> <span class="o">==</span> <span class="s2">&quot; |SWP| &quot;</span><span class="p">:</span>
            <span class="c1"># SWAPの時だけ別に描く, どこがスワップするのか少し見にくかったので. 下のelse以下の表示法でも可.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_SWAP_gate_string</span><span class="p">(</span><span class="n">gate_size</span><span class="p">,</span> <span class="n">t_list</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># SWAP以外の全てのゲートは以下</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_head</span><span class="p">)</span>  <span class="c1"># ゲートの一番頭部分</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_name</span><span class="p">)</span>  <span class="c1"># ゲートの種類表示の部分</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-|</span><span class="si">{}</span><span class="s2">|-&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>  <span class="c1"># ゲートの追加番号or空白の部分</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">3</span><span class="p">):</span>  <span class="c1"># 左右の壁の部分を描くループ</span>
                <span class="c1"># ((i+2)//4)+(描き始めのqubitのインデックス)は現在いるqubitのインデックス描いているqubitのインデックス</span>
                <span class="n">q_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">q_index</span> <span class="ow">in</span> <span class="n">t_list</span><span class="p">:</span>
                    <span class="c1"># 現在描いている壁がターゲットqubitのリストの中にあるとき,</span>
                    <span class="c1"># つまり, 今描いている壁の部分は実際にゲートが適用されるqubitであるとき</span>
                    <span class="c1"># i%4の値でゲートのどの部分を描いているかが分かる(1つのゲートの高さが4なため)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># 余りが0のときは横向きのワイヤーが接続する部分なのでwith_wireを繋ぐ</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body_with_wire</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># 余りが1のときはゲートの底部分, または離れたqubitにかかるゲートを描いているときの</span>
                        <span class="c1"># 横幅が狭い(1文字分)の壁の部分. どちらかによって描き方が変わる.</span>
                        <span class="k">if</span> <span class="n">q_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">t_list</span><span class="p">:</span>
                            <span class="c1"># 今描いているqubitのインデックス+1のqubitもゲートがかかるとき,</span>
                            <span class="c1"># つまり, 次のqubitもゲートがかかるとき</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body</span><span class="p">)</span>  <span class="c1"># 3文字分のゲート幅の壁を追加</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># 今描いているqubitのインデックス+1のqubitにはゲートがかからないとき,</span>
                            <span class="c1"># つまり, 今描いているのqubitの隣のqubitにはゲートがかからず,</span>
                            <span class="c1"># 離れたqubitにゲートがかかるとき(ゲートのかかるqubitが隣接していないとき)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot; |_ _| &quot;</span>
                            <span class="p">)</span>  <span class="c1"># 次のqubitにはかからないことを示すため狭める</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># 余りが2のときはゲートの頭部分, または連続したqubitにかかる多qubitゲートを</span>
                        <span class="c1"># 描いているときの3文字分のゲートの壁の部分. どちらかによって描き方が変わる.</span>
                        <span class="k">if</span> <span class="n">q_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">t_list</span><span class="p">:</span>
                            <span class="c1"># 今描いているqubitの1つ前のqubitにもゲートがかかっていたとき,</span>
                            <span class="c1"># つまり, 前のqubitのゲートと連続して今描いているqubitにもゲートがかかるとき</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body</span><span class="p">)</span>  <span class="c1"># 3文字分のゲート幅の壁を追加</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># 今描いているqubitの1つ前のqubitにはゲートがかかっていなかったとき,</span>
                            <span class="c1"># つまり, 前のqubitはゲートのかからないqubitで今描いているqubitが実は</span>
                            <span class="c1"># 離れた位置に存在したゲートのかかるqubitのとき</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s2">&quot; _| |_ &quot;</span>
                            <span class="p">)</span>  <span class="c1"># このqubitからゲートがかかることを示すため広げる</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># 余りが3のときはgate_nameにあたる部分だが, 多qubitゲートの場合は描くものがない</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body</span><span class="p">)</span>  <span class="c1"># 3文字分のゲートの壁を追加</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 現在描いている壁がターゲットqubitのリストの中にないとき,</span>
                    <span class="c1"># つまり, 今描いている壁の部分は実際にゲートが適用されないqubitで</span>
                    <span class="c1"># もっと下の(離れた位置にある)qubitにかかるゲートを描くための間の部分のqubitのときである.</span>
                    <span class="c1"># このときは, 今のqubitにはかかっていないことを見やすくするためにゲートの幅を1文字分に変更したものを表示する</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># この位置は横向きのワイヤーを描く部分</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--| |--&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># ゲート幅が1文字分になるようのゲートの左右の壁を描く</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  | |  &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_bottom</span><span class="p">)</span>  <span class="c1"># ゲートの最も底部分</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_SWAP_gate_string</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gate_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">t_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">index</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;SWAPゲートをきれいに描くためのメソッド&quot;&quot;&quot;</span>
        <span class="c1"># ゲートの上部分の形, SWAPは空</span>
        <span class="n">gate_head</span> <span class="o">=</span> <span class="s2">&quot;       &quot;</span>
        <span class="c1"># ゲートの名前が表示される部分の形, verbose=Trueのときは追加された順番でそれ以外は空</span>
        <span class="n">gate_name</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># SWAPする位置を表す部分. この部分が他のゲートの場合と異なり, &quot;×&quot;が着くのは</span>
        <span class="c1"># SWAPする2点のqubitのみでその間のqubitのワイヤーは接続の縦線ワイヤーで描きたい</span>
        <span class="n">swap_body_with_wire</span> <span class="o">=</span> <span class="s2">&quot;---x---&quot;</span>
        <span class="n">gate_body_with_wire</span> <span class="o">=</span> <span class="s2">&quot;---|---&quot;</span>
        <span class="c1"># 右壁と左壁の部分, SWAPの場合はSWAPするqubit同士を繋ぐ縦線のワイヤー</span>
        <span class="n">gate_body</span> <span class="o">=</span> <span class="s2">&quot;   |   &quot;</span>
        <span class="c1"># ゲートの下部分の形, SWAPは空</span>
        <span class="n">gate_bottom</span> <span class="o">=</span> <span class="s2">&quot;       &quot;</span>

        <span class="c1"># 作成し始める</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_head</span><span class="p">)</span>  <span class="c1"># 頭部分</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_name</span><span class="p">)</span>  <span class="c1"># ゲートの種類表示の部分</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">swap_body_with_wire</span><span class="p">)</span>  <span class="c1"># SWAPする1つ目のqubitの&quot;×&quot;部分</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gate_size</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">4</span><span class="p">):</span>  <span class="c1"># 左右の壁の部分</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body_with_wire</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">swap_body_with_wire</span><span class="p">)</span>  <span class="c1"># SWAPする2つ目のqubitの&quot;×&quot;部分</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gate_bottom</span><span class="p">)</span>  <span class="c1"># 底部分</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_inner_control_part</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cv_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ControlQubitInfo</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;実ゲートが離れたqubitにかかる場合で, 制御qubitがその間にあるときに描くメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 実ゲートの間に存在している制御qubitのリストを作成</span>
        <span class="n">inner_c_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cv_list</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 上で作成したリストを基に, 既に作成済みである実ゲートを上書きする(空リストの時はなにもしない)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inner_c_list</span><span class="p">:</span>
            <span class="c1"># (取得した制御qubitのインデックス)-(実ゲートの一番上のqubit)で描き始めのqubitから</span>
            <span class="c1"># 何個下のqubitに描き込めばよいか分かる. この値をゲートの高さ分修正(*4-2)して中央をドットに書き換える</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">t_list</span><span class="p">))</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">control_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">control_dot_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrlo</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control_dot_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrl</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="n">row</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">control_dot_str</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">4</span><span class="p">:]</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_lower_control_part</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">t_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cv_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ControlQubitInfo</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ターゲットqubitにかかるゲートより下側に存在する制御qubitを描くメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 以下制御qubit用のパーツ作り</span>
        <span class="c1"># 制御qubit用の部分の接続の部分の形</span>
        <span class="n">control_q_body</span> <span class="o">=</span> <span class="s2">&quot;   </span><span class="si">{}</span><span class="s2">   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrl</span><span class="p">)</span>
        <span class="n">control_o_q_body</span> <span class="o">=</span> <span class="s2">&quot;   </span><span class="si">{}</span><span class="s2">   &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrlo</span><span class="p">)</span>
        <span class="c1"># 制御信号用のワイヤーの形</span>
        <span class="n">vertical_wire</span> <span class="o">=</span> <span class="s2">&quot;   |   &quot;</span>

        <span class="c1"># ターゲットqubitにかかるゲートよりの下側に存在している制御qubitのリスト</span>
        <span class="n">below_c_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ControlQubitInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cv_list</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># 制御qubitと実ゲートのqubitでもっとも離れているqubit(実ゲートのqubitは一番下のqubit)を選び</span>
        <span class="c1"># 距離を計算. このqubitから下へと縦向きのワイヤーを引く</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">below_c_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertical_wire</span><span class="p">)</span>

        <span class="c1"># 制御信号をどのワイヤーからとっているか表す&quot;･&quot;を描き込む</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">below_c_list</span><span class="p">:</span>
            <span class="c1"># 制御qubitとゲートとの距離を計算</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_list</span><span class="p">)</span>
            <span class="c1"># 仕様に合わせて位置を調整</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">loop</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="c1"># 配列に&quot;･&quot;を描き込み(上書き)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">control_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_o_q_body</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_string</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">control_q_body</span>


<div class="viewcode-block" id="TextCircuitDrawer"><a class="viewcode-back" href="../../../qulacsvis.visualization.text.html#qulacsvis.visualization.text.TextCircuitDrawer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">TextCircuitDrawer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;qulacsの量子回路(QuantumCircuit)を描画するためのクラス&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">dot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># 制御qubitの記号</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span> <span class="o">=</span> <span class="n">_set_con_dot</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
        <span class="c1"># 出力したい量子回路</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circ</span> <span class="o">=</span> <span class="n">circuit</span>
        <span class="c1"># 出力したい量子回路の深さ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">calculate_depth</span><span class="p">()</span>
        <span class="c1"># 出力したい量子回路のqubit数</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span> <span class="o">=</span> <span class="n">circuit</span><span class="o">.</span><span class="n">get_qubit_count</span><span class="p">()</span>

        <span class="c1"># 量子回路図をできるだけ左詰め(回路が浅くなるよう)に配置するための参照する配列</span>
        <span class="c1"># 2次元配列であり要素数は(qubit数)*(回路の深さ) &lt;= 場合により深くなっていく</span>
        <span class="c1"># 各qubitのそれぞれの深さにおいてゲートをセットできる場合はTrueを, できない場合はFalseを表示する</span>
        <span class="c1"># 例) gate_map = [[False, False, True],  ← 1qubit目</span>
        <span class="c1">#                 [False, True,  True],  ← 2qubit目</span>
        <span class="c1">#                 [True,  True,  True]]  ← 3qubit目</span>
        <span class="c1">#                   ↑      ↑      ↑</span>
        <span class="c1">#                  深さ1   深さ2   深さ3</span>
        <span class="c1"># 上のgate_mapは</span>
        <span class="c1"># ・1qubit目は深さ1と深さ2ですでにゲートが存在している, 次にゲートを適用できるのは深さ3の場所</span>
        <span class="c1"># ・2qubit目は深さ1の場所にすでにゲートが存在している, 次にゲートを適用できるのは深さ2の場所</span>
        <span class="c1"># ・3qubit目はまだゲートが存在していない, 次にゲートを適用できるのは深さ1の場所</span>
        <span class="c1"># を表す</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># 量子回路の文字列表示を保持させる変数(2次元配列)</span>
        <span class="c1"># 要素に文字1文字を割り当て、回路図として表現する方針</span>
        <span class="c1"># 大きさは縦が(qubit数×4). 4は1つのゲートの縦幅.</span>
        <span class="c1">#       横が(深さ×7)+(深さ-1)+2. 7は1つのゲートの横幅. (深さ-1)は各深さに存在するゲート同士を</span>
        <span class="c1">#                              &quot;-&quot;で繋ぐため,その数. +2は回路の左端と右端を&quot;-&quot;1文字で描画するため.</span>
        <span class="c1"># 以下イメージ</span>
        <span class="c1">#              深さが1と2のゲートの</span>
        <span class="c1">#  左端        間のワイヤーの位置       右端</span>
        <span class="c1">#   ↓               ↓               ↓</span>
        <span class="c1">#   0 1 2 3 4 5 6 7 8 9 A B C D E F 10 (&lt;=16進数表示) ←横サイズ</span>
        <span class="c1"># 0       _ _ _</span>
        <span class="c1"># 1     |   X   |</span>
        <span class="c1"># 2 - - |       | - - - - - ･ - - - -</span>
        <span class="c1"># 3     | _ _ _ |           |</span>
        <span class="c1"># 4                       _ | _</span>
        <span class="c1"># 5                     | D e M |</span>
        <span class="c1"># 6 - - - - - - - - - - |       | - -</span>
        <span class="c1"># 7                     | _ _ _ |</span>
        <span class="c1"># ↑縦サイズ                &lt;=====&gt; ゲートの幅は3文字分, これに前後の壁である&quot;-|&quot;, &quot;|-&quot;を</span>
        <span class="c1">#                                合わせると１つのゲートの幅は7文字分.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vertical_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span> <span class="o">*</span> <span class="mi">4</span>  <span class="c1"># 縦サイズ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># 横サイズ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertical_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span><span class="p">),</span> <span class="s2">&quot; &quot;</span>
        <span class="p">)</span>  <span class="c1"># 配列作成,空白1文字で初期化</span>
        <span class="c1"># 量子回路の左端と右端のワイヤーを&quot;-&quot;で描いておく</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">):</span>
            <span class="c1"># 横向きのワイヤーがある場所は配列番号で2,6,10,14,...番目</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

        <span class="c1"># 単体のゲートの文字列表現を作成するクラスを呼び出す</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AA_Generator</span> <span class="o">=</span> <span class="n">_Gate_AA_Generator</span><span class="p">(</span><span class="n">dot</span><span class="o">=</span><span class="n">dot</span><span class="p">)</span>

<div class="viewcode-block" id="TextCircuitDrawer.draw"><a class="viewcode-back" href="../../../qulacsvis.visualization.text.html#qulacsvis.visualization.text.TextCircuitDrawer.draw">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;実際に回路を描き始め出力までするメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 出力したい量子回路の持つゲート数を取得</span>
        <span class="n">gate_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circ</span><span class="o">.</span><span class="n">get_gate_count</span><span class="p">()</span>
        <span class="c1"># ゲートを１つずつ取り出し回路図に描き込んでいく</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gate_num</span><span class="p">):</span>
            <span class="n">gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circ</span><span class="o">.</span><span class="n">get_gate</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># 確率的に作用するゲートなどでtarget_qubitのインデックスが無いものはスキップする</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gate</span><span class="o">.</span><span class="n">get_target_index_list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;CAUTION: The </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th Gate you added is skipped.&quot;</span>
                    <span class="o">+</span> <span class="s1">&#39;This gate does not have &quot;target_qubit_list&quot;&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_draw_gate</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># ゲートを描き終えたら, ゲート同士や接続が切れているワイヤーを繋ぐ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_wire</span><span class="p">()</span>

        <span class="c1"># 描き込まれたゲートを実際に出力する</span>
        <span class="c1"># ただし、回路の長さに応じて表示方法を変える</span>
        <span class="n">terminal_size</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">get_terminal_size</span><span class="p">()</span><span class="o">.</span><span class="n">columns</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># プロンプトの1行に表示できる文字数-1</span>
        <span class="c1"># プロンプトに収まる場合は普通に表示</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span> <span class="o">&lt;=</span> <span class="n">terminal_size</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="c1"># 回路が長いときは途中で折り返して表示する</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 折り返して表示するときの、表示を繰り返す回数</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span> <span class="o">//</span> <span class="n">terminal_size</span>
            <span class="c1"># 折り返して表示する際の区切り文字。&quot;#&quot;で区切る</span>
            <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="n">terminal_size</span>
            <span class="c1"># 回路図のどこまでを表示したか思えておく変数</span>
            <span class="n">plot_range</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># プロンプトの横幅までの表示を繰り返す</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="c1"># 今何回目の表示かを出力</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># 回路図の出力</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">plot_range</span> <span class="p">:</span> <span class="n">plot_range</span> <span class="o">+</span> <span class="n">terminal_size</span><span class="p">]))</span>
                <span class="c1"># 表示済みの回路図を記憶</span>
                <span class="n">plot_range</span> <span class="o">+=</span> <span class="n">terminal_size</span>
                <span class="c1"># 区切りの出力</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="c1"># 回路の最後の部分の表示</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">plot_range</span><span class="p">:]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_gate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate</span><span class="p">:</span> <span class="n">QuantumGateBase</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;引数にgateをとり, 「ゲートの文字化」, 「適切な位置に描き込み」 の順で実際に描き込むメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 単一のゲートの文字列表示を作成</span>
        <span class="n">gate_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AA_Generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">gate</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># 実際にゲートが適用されるターゲットqubitと, コントロール用の制御qubitのリストを取得</span>
        <span class="n">target_qubit_list</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">get_target_index_list</span><span class="p">()</span>
        <span class="n">control_qubit_list</span> <span class="o">=</span> <span class="n">gate</span><span class="o">.</span><span class="n">get_control_index_list</span><span class="p">()</span>
        <span class="c1"># 続いて, 制御qubitとターゲットqubitの両方を合わせた, 実際にゲートがかかるqubitのリストを取得.</span>
        <span class="n">tc_list</span> <span class="o">=</span> <span class="n">target_qubit_list</span> <span class="o">+</span> <span class="n">control_qubit_list</span>
        <span class="c1"># これは例えばCNOT(0,2), X(1)のような回路を描こうとしたとき, 回路の深さは1だがそのまま深さ1で描こうとすると</span>
        <span class="c1"># ゲートの追加順に応じて CNOTの制御用ワイヤー上にXゲートが乗ってしまう or Xゲートで縦向きの制御信号の上書き</span>
        <span class="c1"># が起こってしまった. よって, 本プログラムでは回路の深さを増やして表示が重ならないようにして対応しようと考えた.</span>
        <span class="c1"># 方針として制御qubitとターゲットqubitが離れている場合を想定し, 間にまたがるqubit全てを確保することで実装する.</span>

        <span class="c1"># circuit_pictureに描き込むに必要な左上隅のインデックスを取得</span>
        <span class="c1"># 引数は使用するqubitのリストの最小値と最大値</span>
        <span class="n">upper_left_corner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_place_check</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tc_list</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">tc_list</span><span class="p">))</span>
        <span class="c1"># 作成した文字列表示をircuit_pictureに描き込む</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_gate_on_picture</span><span class="p">(</span><span class="n">gate_string</span><span class="p">,</span> <span class="n">upper_left_corner</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_place_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_v</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">max_v</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;適切なゲートの描き込み位置を計算するメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 回路の浅い所から探索</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">):</span>
            <span class="c1"># 使用したいqubitすべてが利用できるかチェック</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span><span class="p">[</span><span class="n">min_v</span> <span class="p">:</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]):</span>
                <span class="c1"># 現在使うqubitの位置をFalseに変更する</span>
                <span class="c1"># このときTrueの場所(ゲートのかかる場所)より左側も全部Falseにする</span>
                <span class="c1"># そうしておかないと, 左詰めで適用する実装になっているので</span>
                <span class="c1"># 後から適用する1qubitゲートがその前にかかってしまったりする</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span><span class="p">[</span><span class="n">min_v</span> <span class="p">:</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># 最終的に作成する２次元配列で考えた場合のqubitの位置・深さを計算するため</span>
                <span class="c1"># gate_mapの場合の計算結果を変数に保持させて終了する</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

            <span class="c1"># 一番深いとこまで探索したのに, 描き込める場所が見つからなかったとき</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">:</span>
                <span class="c1"># gate_mapとcircuit_pictureを拡張する</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expand_map_and_picture</span><span class="p">()</span>
                <span class="c1"># 追加した場所にゲートを割り当てていく</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span><span class="p">[</span><span class="n">min_v</span> <span class="p">:</span> <span class="n">max_v</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># 仕様(２次元配列)に合わせて位置を調整</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">min_v</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_map_and_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;回路図が重なって表示されないように深さを増やすメソッド&quot;&quot;&quot;</span>
        <span class="c1"># self.gate_mapの拡張</span>
        <span class="n">additional_gate_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">gate_map</span><span class="p">,</span> <span class="n">additional_gate_map</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># self.circuit_pictureを拡張</span>
        <span class="n">additional_circuit_pic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">vertical_size</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">,</span> <span class="n">additional_circuit_pic</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># 右端を&quot;-&quot;でセット</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">):</span>
            <span class="c1"># 横向きのワイヤーがある場所は配列番号で2,6,10,14,...番目</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

        <span class="c1"># 深さを+1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># 深さが+1になったのでcircuit_pictureの横サイズも増やす</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span> <span class="o">+=</span> <span class="mi">8</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_gate_on_picture</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">gate_string</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ulc</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;作成したゲート文字列を実際に描き込むメソッド&quot;&quot;&quot;</span>
        <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">ulc</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">gate_string</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span> <span class="p">:</span> <span class="n">col</span> <span class="o">+</span> <span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;量子回路の横向きのワイヤーの接続を補うメソッド&quot;&quot;&quot;</span>
        <span class="c1"># 回路のqubit数回ループ</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qubit_num</span><span class="p">):</span>
            <span class="c1"># 横向きのワイヤーがある場所は配列番号で2,6,10,14,...番目</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="c1"># 先頭から１文字ずつ調査していくための変数</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># 各行の先頭から見ていく</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># 先頭の文字を読む</span>
                <span class="n">char_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">char_now</span> <span class="ow">in</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrl</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">CON_DOT</span><span class="o">.</span><span class="n">ctrlo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                    <span class="c1"># 読んだのが&quot;･&quot;のときは次の文字が必ず空白になっているはずなので&quot;-&quot;に書き換える</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="k">elif</span> <span class="n">char_now</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="c1"># 読んだのが&quot;-&quot;のときは次の１文字を読む</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                        <span class="c1"># &quot;-&quot;の次が&quot; &quot;(空白)なので&quot;-&quot;に書き換えワイヤーを繋げる</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
                        <span class="c1"># 読んだ文字が&quot;|&quot;のときはゲートの左壁にぶつかったorコントロールユニタリの制御信号(縦線)のどちらか</span>
                        <span class="c1"># 最初に, 3文字分(通常のゲートの横幅分)を空けて次の文字を読んでみる</span>
                        <span class="c1"># つまりp+1 + 3 + 1文字分先を読む</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
                            <span class="c1"># ぶつかったのは通常のゲートの幅の左壁だったので, ゲートの右側まで抜ける</span>
                            <span class="c1"># 現在位置pは(左壁の位置-1)で+5すれば現在地は右壁の&quot;|&quot;になる</span>
                            <span class="c1"># そして最後のインクリメントで右壁の次にいく</span>
                            <span class="n">p</span> <span class="o">+=</span> <span class="mi">5</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;|&quot;</span><span class="p">:</span>
                            <span class="c1"># ぶつかったのは離れたqubitにかかるゲート用の壁(幅の狭いゲート)の左壁だった</span>
                            <span class="c1"># +3すれば現在地は右壁の&quot;|&quot;になるので, 最後のインクリメントで右壁の次にいく</span>
                            <span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># 読んでみるとゲートの右の壁でない =&gt; 読んだのはコントロールユニタリの縦線だった</span>
                            <span class="c1"># なので次の空白を&quot;-&quot;とする</span>
                            <span class="c1"># &quot;|&quot;を&quot;+&quot;に書き換えワイヤーがクロスする表示も試したが,</span>
                            <span class="c1"># どこが制御qubitかわかりにくかったのでやめた.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">circuit_picture</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                            <span class="c1"># 次に読む文字を今変更した&quot;-&quot;にするために調整</span>
                            <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># インクリメントして次の文字の位置をセット</span>
                <span class="n">p</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># もしインクリメントしたときに配列のサイズを超えたら終了</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">horizontal_size</span><span class="p">:</span>
                    <span class="k">break</span></div>


<div class="viewcode-block" id="draw_circuit"><a class="viewcode-back" href="../../../qulacsvis.visualization.text.html#qulacsvis.visualization.text.draw_circuit">[docs]</a><span class="k">def</span><span class="w"> </span><span class="nf">draw_circuit</span><span class="p">(</span>
    <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dot</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    量子回路図をテキストで出力するための関数</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    circuit: qulacs.QuantumCircuit</span>
<span class="sd">        出力したい量子回路(qulacs.QuantumCircuit)</span>
<span class="sd">    verbose: bool</span>
<span class="sd">        詳細出力(default=False). Trueのときはgateにcircuitに追加された順番が出力される</span>
<span class="sd">    dot: str</span>
<span class="sd">        制御qubitを表すドットのスタイル(default=&quot;large&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Drawer</span> <span class="o">=</span> <span class="n">TextCircuitDrawer</span><span class="p">(</span><span class="n">circuit</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="n">dot</span><span class="p">)</span>
    <span class="n">Drawer</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Qulacs-Osaka.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>